<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner - –§–∞—Å–æ–ª—å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        
        #scanner-container {
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }
        
        #qr-video {
            width: 100%;
            max-width: 300px;
            height: 300px;
            border: 2px solid #007bff;
            border-radius: 10px;
            object-fit: cover;
        }
        
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        h1 {
            color: var(--tg-theme-text-color, #000000);
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>üîç QR Scanner</h1>
    <div id="scanner-container">
        <video id="qr-video"></video>
        <div id="result" class="info">
            üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –∫—É–ø–æ–Ω–∞
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram?.WebApp;
        
        if (tg) {
            tg.ready();
            tg.expand();
            tg.MainButton.setText("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å");
            tg.MainButton.show();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
            tg.MainButton.onClick(() => {
                if (window.qrScanner) {
                    window.qrScanner.stop();
                }
                tg.close();
            });
        }
        
        const video = document.getElementById('qr-video');
        const resultDiv = document.getElementById('result');
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function showResult(message, type = 'info') {
            resultDiv.className = type;
            resultDiv.innerHTML = message;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è QR-—Å–∫–∞–Ω–µ—Ä–∞
        try {
            window.qrScanner = new QrScanner(
                video,
                result => {
                    console.log('–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω QR-–∫–æ–¥:', result.data);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫—É–ø–æ–Ω–∞ –§–∞—Å–æ–ª—å
                    if (result.data.startsWith('FASOLEY_COUPON_')) {
                        showResult('‚úÖ QR-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω! –ü–æ–≥–∞—à–∞–µ–º –∫—É–ø–æ–Ω...', 'success');
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞
                        if (tg) {
                            tg.sendData(JSON.stringify({
                                action: 'redeem_coupon',
                                qr_data: result.data,
                                timestamp: new Date().toISOString()
                            }));
                            
                            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
                            setTimeout(() => {
                                tg.close();
                            }, 1000);
                        } else {
                            showResult('‚úÖ QR-–∫–æ–¥: ' + result.data, 'success');
                        }
                        
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä
                        window.qrScanner.stop();
                        
                    } else {
                        showResult('‚ùå –≠—Ç–æ –Ω–µ –∫—É–ø–æ–Ω –º–∞–≥–∞–∑–∏–Ω–∞ –§–∞—Å–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π QR-–∫–æ–¥.', 'error');
                    }
                },
                {
                    highlightScanRegion: true,
                    highlightCodeOutline: true,
                    maxScansPerSecond: 5,
                    preferredCamera: 'environment' // –ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞
                }
            );
            
            // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
            window.qrScanner.start().then(() => {
                console.log('QR Scanner –∑–∞–ø—É—â–µ–Ω');
                showResult('üì∑ –ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥ –∫—É–ø–æ–Ω–∞.', 'info');
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞:', error);
                showResult('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.', 'error');
            });
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ QR-—Å–∫–∞–Ω–µ—Ä–∞:', error);
            showResult('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫–∞–Ω–µ—Ä–∞', 'error');
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (window.qrScanner) {
                window.qrScanner.stop();
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∫–∞–º–µ—Ä—ã
        video.addEventListener('error', (e) => {
            console.error('–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ:', e);
            showResult('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ', 'error');
        });
    </script>
</body>
</html>
